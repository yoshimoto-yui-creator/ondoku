import React, { useState, useRef, useEffect } from 'react';
import { 
  Mic, 
  Square, 
  Play, 
  Pause, 
  CheckCircle, 
  AlertCircle, 
  Award, 
  Upload, 
  Users, 
  User, 
  Settings,
  RefreshCw
} from 'lucide-react';

// --- Configuration ---
const apiKey = ""; // Gemini API Key required for real AI analysis

const STAMPS = {
  EXCELLENT: { label: 'Excellent!', color: 'text-yellow-500', icon: 'â­' },
  GOOD: { label: 'Good Job!', color: 'text-green-500', icon: 'ğŸ‘' },
  TRY_AGAIN: { label: 'Try Again', color: 'text-blue-500', icon: 'ğŸ“' }
};

const App = () => {
  const [view, setView] = useState('landing'); // 'landing', 'student', 'teacher'
  const [task, setTask] = useState({
    text: "The quick brown fox jumps over the lazy dog.",
    audioUrl: null,
  });
  const [studentInfo, setStudentInfo] = useState({ number: '', name: '' });
  const [recording, setRecording] = useState(false);
  const [audioBlob, setAudioBlob] = useState(null);
  const [audioUrl, setAudioUrl] = useState(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [result, setResult] = useState(null);
  
  const mediaRecorder = useRef(null);
  const audioChunks = useRef([]);

  // --- Functions ---

  const startRecording = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder.current = new MediaRecorder(stream);
      audioChunks.current = [];

      mediaRecorder.current.ondataavailable = (event) => {
        audioChunks.current.push(event.data);
      };

      mediaRecorder.current.onstop = () => {
        const blob = new Blob(audioChunks.current, { type: 'audio/wav' });
        setAudioBlob(blob);
        setAudioUrl(URL.createObjectURL(blob));
      };

      mediaRecorder.current.start();
      setRecording(true);
      setResult(null);
    } catch (err) {
      console.error("Error accessing microphone:", err);
      alert("ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
    }
  };

  const stopRecording = () => {
    if (mediaRecorder.current && recording) {
      mediaRecorder.current.stop();
      setRecording(false);
    }
  };

  const analyzeAudio = async () => {
    if (!audioBlob || !apiKey) {
      // APIã‚­ãƒ¼ãŒãªã„å ´åˆã®ãƒ‡ãƒ¢ç”¨ãƒ€ãƒŸãƒ¼åˆ¤å®š
      setIsAnalyzing(true);
      setTimeout(() => {
        const words = task.text.split(/\s+/);
        const feedback = words.map(word => ({
          word,
          isCorrect: Math.random() > 0.2
        }));
        const score = Math.round((feedback.filter(f => f.isCorrect).length / words.length) * 100);
        let stamp = STAMPS.TRY_AGAIN;
        if (score > 85) stamp = STAMPS.EXCELLENT;
        else if (score > 60) stamp = STAMPS.GOOD;

        setResult({ feedback, score, stamp });
        setIsAnalyzing(false);
      }, 2000);
      return;
    }

    setIsAnalyzing(true);
    try {
      const reader = new FileReader();
      reader.readAsDataURL(audioBlob);
      reader.onloadend = async () => {
        const base64Data = reader.result.split(',')[1];
        
        const prompt = `
          Compare this audio of a student reading a text with the target text: "${task.text}".
          Identify which words were spoken correctly and which were incorrect or missed.
          Return a JSON object with:
          - feedback: array of objects { word: string, isCorrect: boolean }
          - score: number (0-100)
        `;

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: prompt },
                { inlineData: { mimeType: "audio/wav", data: base64Data } }
              ]
            }],
            generationConfig: { responseMimeType: "application/json" }
          })
        });

        const data = await response.json();
        const analysis = JSON.parse(data.candidates[0].content.parts[0].text);
        
        let stamp = STAMPS.TRY_AGAIN;
        if (analysis.score > 85) stamp = STAMPS.EXCELLENT;
        else if (analysis.score > 60) stamp = STAMPS.GOOD;

        setResult({ ...analysis, stamp });
      };
    } catch (error) {
      console.error("AI Analysis failed:", error);
    } finally {
      setIsAnalyzing(false);
    }
  };

  // --- Views ---

  const LandingView = () => (
    <div className="flex flex-col items-center justify-center min-h-[60vh] space-y-8">
      <div className="text-center">
        <h1 className="text-4xl font-bold text-slate-800 mb-2">éŸ³èª­æå‡ºã‚·ã‚¹ãƒ†ãƒ </h1>
        <p className="text-slate-500 text-lg">é«˜æ ¡2å¹´ç”Ÿ è‹±èªãƒ»å›½èªèª²é¡Œç”¨</p>
      </div>
      <div className="flex flex-col sm:flex-row gap-4 w-full max-w-md">
        <button 
          onClick={() => setView('student')}
          className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 px-4 rounded-2xl shadow-lg transition-all flex flex-col items-center gap-3"
        >
          <User size={40} />
          ç”Ÿå¾’ã¨ã—ã¦ç·´ç¿’ãƒ»æå‡º
        </button>
        <button 
          onClick={() => setView('teacher')}
          className="flex-1 bg-slate-800 hover:bg-slate-900 text-white font-bold py-6 px-4 rounded-2xl shadow-lg transition-all flex flex-col items-center gap-3"
        >
          <Settings size={40} />
          æ•™å¸«ç”¨ç®¡ç†ç”»é¢
        </button>
      </div>
    </div>
  );

  const TeacherView = () => (
    <div className="max-w-2xl mx-auto space-y-6">
      <div className="flex items-center justify-between">
        <h2 className="text-2xl font-bold flex items-center gap-2">
          <Settings className="text-blue-600" /> æ•™å¸«ç”¨èª²é¡Œè¨­å®š
        </h2>
        <button onClick={() => setView('landing')} className="text-sm text-slate-500 hover:underline">æˆ»ã‚‹</button>
      </div>
      
      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 space-y-4">
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">èª²é¡Œãƒ†ã‚­ã‚¹ãƒˆ</label>
          <textarea 
            className="w-full p-3 border border-slate-300 rounded-lg h-32 focus:ring-2 focus:ring-blue-500 outline-none"
            value={task.text}
            onChange={(e) => setTask({...task, text: e.target.value})}
            placeholder="ç”Ÿå¾’ãŒèª­ã‚€ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-slate-700 mb-1">ãŠæ‰‹æœ¬éŸ³å£° (URL)</label>
          <input 
            type="text" 
            className="w-full p-2 border border-slate-300 rounded-lg"
            placeholder="https://example.com/audio.mp3"
            onChange={(e) => setTask({...task, audioUrl: e.target.value})}
          />
          <p className="text-xs text-slate-400 mt-1">â€»ç”Ÿå¾’ãŒç·´ç¿’ã™ã‚‹éš›ã«å†ç”Ÿã§ãã‚‹éŸ³å£°ã§ã™ã€‚</p>
        </div>
        <button className="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition">
          èª²é¡Œã‚’æ›´æ–°ã™ã‚‹
        </button>
      </div>

      <div className="bg-slate-50 p-6 rounded-xl border border-dashed border-slate-300">
        <h3 className="font-bold mb-2 flex items-center gap-2">
          <Users size={18} /> æå‡ºçŠ¶æ³ (ãƒ‡ãƒ¢)
        </h3>
        <p className="text-sm text-slate-500">æœ¬ç•ªé‹ç”¨æ™‚ã¯ã€ã“ã“ã«ç”Ÿå¾’ã®æå‡ºä¸€è¦§ã¨AIã‚¹ã‚³ã‚¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
      </div>
    </div>
  );

  const StudentView = () => {
    if (!studentInfo.number || !studentInfo.name) {
      return (
        <div className="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl space-y-6 border border-slate-100">
          <h2 className="text-2xl font-bold text-center">æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-slate-600">å‡ºå¸­ç•ªå·</label>
              <input 
                type="number" 
                className="w-full p-3 border rounded-lg" 
                placeholder="ä¾‹: 15"
                value={studentInfo.number}
                onChange={e => setStudentInfo({...studentInfo, number: e.target.value})}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-600">æ°å</label>
              <input 
                type="text" 
                className="w-full p-3 border rounded-lg" 
                placeholder="ä¾‹: å±±ç”° å¤ªéƒ"
                value={studentInfo.name}
                onChange={e => setStudentInfo({...studentInfo, name: e.target.value})}
              />
            </div>
            <button 
              onClick={() => studentInfo.number && studentInfo.name && setView('student_ready')}
              className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold disabled:opacity-50"
              disabled={!studentInfo.number || !studentInfo.name}
            >
              ã¯ã˜ã‚ã‚‹
            </button>
          </div>
          <button onClick={() => setView('landing')} className="w-full text-slate-400 text-sm">æˆ»ã‚‹</button>
        </div>
      );
    }

    return (
      <div className="max-w-3xl mx-auto space-y-6 pb-20">
        <div className="flex justify-between items-center">
          <div className="flex items-center gap-2">
            <div className="bg-blue-100 p-2 rounded-lg">
              <User className="text-blue-600" size={20} />
            </div>
            <span className="font-bold text-slate-700">{studentInfo.number}ç•ª {studentInfo.name}ã•ã‚“</span>
          </div>
          <button onClick={() => setView('landing')} className="text-slate-400 hover:text-slate-600"><RefreshCw size={20}/></button>
        </div>

        {/* Text Area */}
        <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 min-h-[200px] relative">
          <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Reading Text</h3>
          <div className="text-2xl leading-relaxed text-slate-800 font-medium">
            {result ? (
              <div className="flex flex-wrap gap-2">
                {result.feedback.map((f, i) => (
                  <span key={i} className={f.isCorrect ? 'text-slate-800' : 'text-red-500 border-b-2 border-red-300'}>
                    {f.word}
                  </span>
                ))}
              </div>
            ) : (
              task.text
            )}
          </div>
        </div>

        {/* Help Audio */}
        {task.audioUrl && (
          <div className="flex items-center gap-4 bg-slate-50 p-4 rounded-2xl border border-slate-100">
            <button className="bg-slate-800 text-white p-2 rounded-full hover:scale-105 transition">
              <Play fill="currentColor" size={20} />
            </button>
            <div>
              <p className="text-sm font-bold">å…ˆç”Ÿã®ãŠæ‰‹æœ¬ã‚’è´ã</p>
              <p className="text-xs text-slate-500">è´ã„ã¦ã‹ã‚‰ç·´ç¿’ã—ã¦ã¿ã¾ã—ã‚‡ã†</p>
            </div>
          </div>
        )}

        {/* Controls */}
        <div className="flex flex-col items-center gap-6 pt-4">
          {!recording ? (
            <button 
              onClick={startRecording}
              className="group relative flex items-center justify-center w-24 h-24 bg-red-500 text-white rounded-full shadow-xl shadow-red-200 hover:bg-red-600 transition-all active:scale-95"
            >
              <Mic size={40} />
              <span className="absolute -bottom-8 text-red-500 font-bold text-sm">éŒ²éŸ³ã‚’é–‹å§‹</span>
            </button>
          ) : (
            <button 
              onClick={stopRecording}
              className="group relative flex items-center justify-center w-24 h-24 bg-slate-800 text-white rounded-full shadow-xl shadow-slate-200 animate-pulse"
            >
              <Square fill="white" size={32} />
              <span className="absolute -bottom-8 text-slate-800 font-bold text-sm">éŒ²éŸ³ä¸­... (åœæ­¢)</span>
            </button>
          )}

          {audioUrl && !recording && (
            <div className="flex flex-col items-center gap-4 w-full animate-in fade-in slide-in-from-bottom-4">
              <audio src={audioUrl} controls className="w-full max-w-xs h-10" />
              <div className="flex gap-4">
                <button 
                  onClick={analyzeAudio}
                  disabled={isAnalyzing}
                  className="bg-blue-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 flex items-center gap-2 disabled:opacity-50"
                >
                  {isAnalyzing ? <RefreshCw className="animate-spin" /> : <CheckCircle />}
                  {isAnalyzing ? "AIæ¡ç‚¹ä¸­..." : "æå‡ºã—ã¦æ¡ç‚¹ã™ã‚‹"}
                </button>
              </div>
            </div>
          )}
        </div>

        {/* AI Result Stamp */}
        {result && (
          <div className="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50 p-6 animate-in zoom-in duration-300">
            <div className="bg-white rounded-3xl shadow-2xl border border-slate-100 p-8 max-w-sm w-full text-center space-y-6">
              <div className={`text-8xl mb-2 animate-bounce`}>
                {result.stamp.icon}
              </div>
              <div>
                <h4 className={`text-4xl font-black ${result.stamp.color}`}>
                  {result.stamp.label}
                </h4>
                <p className="text-slate-500 mt-2 font-bold text-xl">Score: {result.score}%</p>
              </div>
              <p className="text-slate-600 text-sm">
                èµ¤ããªã£ã¦ã„ã‚‹å˜èªã«æ°—ã‚’ã¤ã‘ã¦ã€ã‚‚ã†ä¸€åº¦ç·´ç¿’ã—ã¦ã¿ã‚ˆã†ï¼
              </p>
              <button 
                onClick={() => setResult(null)}
                className="w-full py-3 bg-slate-100 rounded-xl font-bold hover:bg-slate-200"
              >
                é–‰ã˜ã‚‹
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans p-4 sm:p-8">
      {view === 'landing' && <LandingView />}
      {view === 'teacher' && <TeacherView />}
      {(view === 'student' || view === 'student_ready') && <StudentView />}
      
      {/* Footer Info */}
      <footer className="fixed bottom-4 left-0 right-0 text-center text-xs text-slate-400">
        &copy; 2024 éŸ³èª­æå‡ºã‚¢ãƒ—ãƒª | No Login Required | AI Powered
      </footer>
    </div>
  );
};

export default App;
